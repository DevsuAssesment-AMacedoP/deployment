name: deploy-aks
on:
  push:
    branches:
      - "master"
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v3
      - name: Azure login
        id: login
        uses: azure/login@v1.4.3
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Set AKS context
        id: set-context
        uses: azure/aks-set-context@v3
        with:
          resource-group: '${{ secrets.resource_group }}'
          cluster-name: '${{ secrets.cluster_name }}'
      - name: Setup kubectl
        id: install-kubectl
        uses: azure/setup-kubectl@v3
      - name: 'Deploy'
        uses: 'vimeda/helm@v1.6.8'
        with:
          release: 'devsu-server'
          namespace: 'devsu'
          chart: 'devsu-server'
          token: '${{ github.token }}'
          values: |
            secret:
              api_key: ${{ secrets.DEVSU_API_KEY }}
              jwt_key: ${{ secrets.DEVSU_JWT_KEY }}